## Бот для нетворкинга участников вашей группы в Телеграм.
Вы добавляете бота в свою группу в телеграме, участники вашей группы, которые хотят участвовать в нетворкинге, запускают бота.
Бот с заданной периодичностью (по умолчанию 1 раз в 2 недели) будет формировать случайные пары для встреч на кофе (виртуальных или живых), отправляя участникам ссылку на пользователя, который им выпал в этот раз.
В боте есть 3 роли:
- пользователь: участвует в нетворкинге, может управлять своеим участием: изменять частоту встреч, просматривать свои данные, оставлять фитбэк о встречах, загружать фото и др.
- админ: может управлять ботом и участниками: изменять интервал формирования пар, просматривать список участников, ставить их на паузу или забирать доступ к боту, выгружать данные об участниках, встречах и фитбэке в Гугл Таблицу, отправлять рассылку участникам и др.

## Стэк проекта:
Python 3.12, Aiogram 3, SQLAlchemy, PostgreSQL, Alembic, APScheduler.


## Владельцу бота необходимо выполнить следующие подготовительные шаги:
1. Сформировать текст политики обработки персональных данных и разместить его в сети Интернет (на своем сайте или на Гугл Диске, сделав файл доступным для просмотра по ссылке).
2. Создать бота через BotFather:
- перейдите в BotFather: https://t.me/BotFather
- отправьте команду /newbot
- отправьте название для вашего бота (например, Random Coffee)
- далее отправьте юзернейм, который должен заканчиваться на bot и быть уникальным (можно использовать нижнее подчеркивание, чтобы задать имя типа random_coffee_bot)
- если вы задали уникальный юзернейм, то в ответ получите сообщение об успехе, в котором будет содержаться токен бота (держите его в секрете, так как с помощью него можно перехватить управление вашим ботом)
3. Настроить описание бота, разместив в описании ссылку на политику обработки ПД:
- находясь в BotFather отправьте команду /mybots и выберите из списка нужного бота
- здесь вы можете в любой момент получить токен, выпустить новый токен (если старый был укарден), задать настройки бота
- выберите Edit bot
- выберите Edit Description
- отправьте текст, в котором кратко расскажите, что умеет этот бот. В конце обязательно добавьте строку "Нажимая кнопку "Старт", ты даёшь согласие на обработку персональных данных:" и вставьте ссылку на вашу политику обработки персональных данных.
- в ответ бот сообщит, что успешно обновил описание и покажет 2 кнопки - выберите Back to bot
- снова выберите Edit bot, затем Edit Privacy Policy
- отправьте ссылку на вашу политику обработки персональных данных
- бот пришлет вам сообщение об успехе.
- при необходимости, вы можете задать и другие настройки для бота (например, Botpic - аватарку для него, хотя это можно сделать и в самом боте)
4. Добавить бота в группу, для участников которой будет работать этот бот, и дать ему права администратора.
5. Для интеграции с гугл-таблицами и гугл-диском настроить сервисный аккаунт Гугл по инструкции: https://drive.google.com/file/d/1lwm3AHSZmPZODzdtEqprWRWZKxjm-3Ho/view?usp=sharing
6. Передать разработчику следующие данные:
- токен бота (получить у BotFather)
- ID телеграм-группы
- телеграм ID супер-админа (только супер-админ может давать другим пользователям роль админа)
- файл с данными сервисного аккаунта Гугл
- ID гугл-таблицы
- ID гугл-папки

## Запуск на сервере:
### Шаг 1. Подготовка сервера:
1. Зайдите на сервер и обновите пакеты:
```
sudo apt update && sudo apt upgrade -y
```
2. Установите консольную утилиту curl:
```
sudo apt install curl
```
3. Скачайте скрипт для установки Docker с официального сайта:
```
curl -fSL https://get.docker.com -o get-docker.sh
```
4. Запустите сохранённый скрипт с правами суперпользователя:
```
sudo sh ./get-docker.sh
```
5. Установите Docker Compose:
```
sudo apt install docker-compose-plugin
```
6. Убедитесь, что Docker работает:
```
sudo systemctl status docker
```
Вы должны увидеть статус active. Выйдите из просмотра статуса: Ctrl+C
7. Добавьте своего пользователя в группу docker, чтобы не каждый раз писать sudo:
```
sudo usermod -aG docker $USER
```
После этого ереподключитесь по SSH!

### Шаг 2. Подготовка проекта:
1. В файле main.py задайте дату и время первого формирования пар в строке `await set_first_pairing_date(datetime(ГГГГ, ММ, ДД, ЧЧ, ММ))`
2. Запуште изменения.

### Шаг 3. Настройка интеграции с GitHub по SSH:
1. Для генерации SSH-ключа выполните команду:
```
ssh-keygen
```
2. Консоль попросит ввести путь к файлу, оставьте путь по умолчанию, просто нажав Enter
3. Система попросит придумать пароль для доступа к ключам. Введите пароль (в терминале ничего не отобразится) и запомните его.
Рисунок в окне терминала будет свидетельствовать, что ключи успешно созданы
4. Выведите открытый ключЖ
```
cat .ssh/id_rsa.pub
```
5. Скопируйте ключ от символов ssh-rsa, включительно, и до конца.
6. Зайдите в свой аккаунт на GitHub, перейдите в раздел настроек. Выберите пункт SSH and GPG keys; для создания нового ключа нажмите на кнопку New SSH key в правом верхнему углу.
7. Откроется страница с двумя полями ввода:
- Title - задайте название ключа, чтобы вы понимали в дальнейшем, для чего используете его.
- Key - вставьте сюда скопированный ключ.
8. Нажмите кнопку Add SSH key.
9. Откройте проект в GitHub и нажмите 'Code', выберете SSH и скопируйте ссылку такого вида git@github.com:name/TGbot-Raul-1.git (где name - ваше имя на GitHub)
10. Клонируйте репозиторий в нужную папку на сервере, используя свою SSH-ссылку (в вашей ссылки вместо name будет указано ваше имя в GitHub):
```
git clone git@github.com:name/TGbot-Raul-1.git
```
11. Проверьте, что папка TGbot-Raul-1 появилась у вас на сервере:
```
ls
```
### Шаг 4. Настройка файлов .env и credentials.json
1. Перейдите в папку random_coffee_bot (в ней же лежат .env.example и credentials.example).
```
cd TGbot-Raul-1/random_coffee_bot
```
2. Откройте файл .env (если его нет, то эта команда создаст его):
```
nano .env
```
3. Пропишите в нем все переменные, которые указаны в .env.example, задав им нужные значения, полученные от владельца бота.
Для сохранения файла нажмите Ctrl+S. Чтобы закрыть файл, нажмите Ctrl+X.
4. Откройте файл credentials.example (если его нет, то эта команда создаст его):
```
nano credentials.example
```
5. Скопируйте в этот файл содержимое из файла с данными сервисного аккаунта Гугл.
Для сохранения файла нажмите Ctrl+S. Чтобы закрыть файл, нажмите Ctrl+X.

### Шаг 5. Сборка контейнеров для запуска бота:
1. Находясь в корне проекта (в папке TGbot-Raul-1) выполните команду:
```docker compose up --build -d```
В терминале вы увидите, как поднимается Postgres, ждёт готовности, прогоняет миграции и стартует бот. Это займет какое-то время.
2. Как только контейнеры соберутся, можно пользоваться ботом.
3. Отслеживание логов в терминале при запущенных контейнерах:
- чтобы отслеживать все логи, вместе с базой данных: `docker compose logs -f`
- только логи бота: `docker compose logs -f app`
- чтобы выйти из отслеживания логов, нажмите Ctrl+C.


## Дальнейшая работа с контейнерами:
### Если вы внесли изменения в код и запушили их на GitHub:
1. Находясь на сервере в корневой папке TGbot-Raul-1 подтяните изменения в коде:
```
git pull
```
2. Если вы НЕ вносили изменения в файл .env или Dockerfile, а только меняли основной код бота, достаточно перезапустить контейнер с ботом:
```
docker compose restart app
```
3. Если вы внесли изменения в файл .env:
```
docker compose up -d --force-recreate --no-deps app
```

### Другие команды для работы с контейнерами:
- Остановка контейнеров: `docker compose stop`
- Старт контейнеров: `docker compose start`
- Сброс контейнеров (если вносили изменения в requirements.txt или Docerfile): `docker compose down` (сохраняет БД)
- Собрать с нуля все контейнеры: `docker compose up --build -d` (собрать образы, запустить контейнеры, без просмотра логов)


## Локальный запуск бота через Docker:
### Первичные настройки:
1. Подтяните к себе проект с GitHub
2. Проверьте, установлены ли у вас Docker и Docker Compose, для этого в терминале отправьте команды:
```
docker --version
docker compose version
```
Если нет, то установите Docker Desktop по ссылке: https://docs.docker.com/get-started/get-docker/
Создайте аккаунт и войдите в приложение.
3. Далее выполните шаги 2, 4 и 5 из раздела "Запуск на сервере" (приведенные выше).


Авторы проекта:
[Дуплинская Татьяна](https://github.com/tatiana-dup)
[Горбунов Игорь](https://github.com/boss2004)
[Никифоров Андрей](https://github.com/Andrey232322)